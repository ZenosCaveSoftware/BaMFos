#!/bin/sh
set -e
if [[ $# -ge 1 ]]; then
	while [[ "x$1" != "x--no-staging" && $# -ne 0 ]]; do
		shift;
	done
fi
if [[ $# -eq 0 ]]; then
	. ./build;
fi

[[ -d ../isodir ]] && rm -rf ../isodir 
mkdir -p ../isodir
mkdir -p ../isodir/boot
mkdir -p ../isodir/boot/grub

cp ../sysroot/boot/BaMF.kernel ../isodir/boot/BaMF.kernel
cat > ../isodir/boot/grub/grub.cfg << EOF
menuentry "BaMF-OS" {
	multiboot /boot/BaMF.kernel
}
EOF
grub-mkrescue -o ../BaMF.iso ../isodir;

[[ -f ../BaMF.vdi ]] && rm ../BaMF.vdi;
VBoxManage convertfromraw ../BaMF.iso ../BaMF.vdi
